CREATE TABLE IF NOT EXISTS "Users" (
	"id" SERIAL NOT NULL UNIQUE,
	"name" TEXT NOT NULL,
	"email" TEXT NOT NULL,
	"password" TEXT NOT NULL,
	"archived_at" TIMESTAMPTZ,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "recipe" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"name" TEXT NOT NULL,
	"description" TEXT NOT NULL,
	"createdDate" TIMESTAMPTZ NOT NULL,
	"modifiedDate" TIMESTAMPTZ NOT NULL,
	"user_id" INTEGER NOT NULL,
	"cook_time" SMALLINT,
	"image_url" TEXT,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "ingredients" (
	"id" SERIAL NOT NULL UNIQUE,
	"name" TEXT NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "recipe_ingredients" (
	"recipe_id" INTEGER NOT NULL,
	"ingredients_id" INTEGER NOT NULL,
	"quantity" DECIMAL NOT NULL,
	"unit" TEXT NOT NULL,
	"notes" TEXT,
	PRIMARY KEY("recipe_id", "ingredients_id")
);




CREATE TABLE IF NOT EXISTS "steps" (
	"id" SERIAL NOT NULL UNIQUE,
	"step_num" SMALLINT NOT NULL,
	"description" TEXT NOT NULL,
	"recipe_id" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "tag" (
	"id" SERIAL NOT NULL UNIQUE,
	"name" TEXT NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "recipe_tags" (
	"recipe_id" INTEGER NOT NULL,
	"tag_id" INTEGER NOT NULL,
	PRIMARY KEY("recipe_id", "tag_id")
);




CREATE TABLE IF NOT EXISTS "review" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"rating" SMALLINT CHECK(rating > 0 AND rating < 6),
	"user_id" INTEGER,
	"recipe_id" INTEGER,
	"comment" TEXT,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "replies" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"comment" TEXT,
	"user_id" INTEGER NOT NULL,
	"review_id" INTEGER NOT NULL,
	"parent_reply_id" INTEGER,
	PRIMARY KEY("id")
);



ALTER TABLE "recipe"
ADD FOREIGN KEY("user_id") REFERENCES "Users"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "recipe_ingredients"
ADD FOREIGN KEY("recipe_id") REFERENCES "recipe"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "recipe_ingredients"
ADD FOREIGN KEY("ingredients_id") REFERENCES "ingredients"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "steps"
ADD FOREIGN KEY("recipe_id") REFERENCES "recipe"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "recipe_tags"
ADD FOREIGN KEY("recipe_id") REFERENCES "recipe"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "recipe_tags"
ADD FOREIGN KEY("tag_id") REFERENCES "tag"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "review"
ADD FOREIGN KEY("user_id") REFERENCES "Users"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "review"
ADD FOREIGN KEY("recipe_id") REFERENCES "recipe"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "replies"
ADD FOREIGN KEY("user_id") REFERENCES "Users"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "replies"
ADD FOREIGN KEY("review_id") REFERENCES "review"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "replies"
ADD FOREIGN KEY("parent_reply_id") REFERENCES "replies"("id")
ON UPDATE NO ACTION ON DELETE CASCADE;